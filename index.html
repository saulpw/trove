<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>trove</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
    #links { list-style: none; padding: 0; }
    .link { margin: 0.5rem 0; }
    .link .title { color: #0066cc; }
    .link .url { color: #888; font-size: 0.85em; margin-left: 0.5rem; }
    .link .added { color: #999; font-size: 0.85em; }
    .link .tags { margin-left: 0.5rem; }
    .link .tag { color: #666; font-size: 0.9em; }
    .empty { color: #999; font-style: italic; }
    #add-form { margin-bottom: 1.5rem; display: flex; gap: 0.5rem; align-items: center; }
    #add-form input[type="text"] { flex: 1; padding: 0.5rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; }
    #add-form button { padding: 0.5rem 1rem; font-size: 1rem; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #f5f5f5; }
    #add-form button:hover { background: #e5e5e5; }
    #auth-status { font-size: 0.85em; color: #666; }
    #submit-status { font-size: 0.85em; margin-left: 0.5rem; }
    .status-success { color: #2a2; }
    .status-error { color: #c22; }
  </style>
</head>
<body>
  <h1>trove</h1>

  <div id="add-form">
    <input type="text" id="link-url" placeholder="https://..." />
    <input type="text" id="link-notes" placeholder="Notes (optional)" />
    <button id="submit-btn" onclick="submitLink()">Add</button>
    <button id="auth-btn" onclick="handleAuth()">Sign in</button>
    <span id="submit-status"></span>
  </div>

  <div id="links"></div>

  <script>
    // Parse path or hash to get tag filters: /foo/bar or #foo/bar → ['foo', 'bar']
    // Tags starting with '-' are exclusions: /foo/-bar → include 'foo', exclude 'bar'
    function getTagFilters() {
      const hash = window.location.hash.replace(/^#\/?/, '');
      if (hash) {
        return hash.split('/').filter(s => s.length > 0);
      }
      return window.location.pathname
        .split('/')
        .filter(segment => segment.length > 0 && segment !== 'index.html');
    }

    async function loadLinks() {
      const container = document.getElementById('links');
      const tagFilters = getTagFilters();

      // Update heading to show active filters
      if (tagFilters.length > 0) {
        document.querySelector('h1').textContent = tagFilters.map(t =>
          t.startsWith('-') ? `-#${t.slice(1)}` : `#${t}`
        ).join(' ');
        document.title = tagFilters.join('/') + ' - trove';
      }

      try {
        const response = await fetch('/trove.jsonl');
        const text = await response.text();
        const allLinks = text.trim().split('\n').filter(line => line).map(line => JSON.parse(line));

        // Parse tags from space-separated string to array
        const parseTags = (tags) => tags ? tags.split(' ').filter(t => t) : [];

        // Filter links by tags (must have ALL included tags, none of excluded tags)
        let links = allLinks;
        if (tagFilters.length > 0) {
          const includeTags = tagFilters.filter(t => !t.startsWith('-'));
          const excludeTags = tagFilters.filter(t => t.startsWith('-')).map(t => t.slice(1));
          links = links.filter(link => {
            const linkTags = parseTags(link.tags);
            const hasAllIncluded = includeTags.every(tag => linkTags.includes(tag));
            const hasNoneExcluded = excludeTags.every(tag => !linkTags.includes(tag));
            return hasAllIncluded && hasNoneExcluded;
          });
        }

        if (links.length === 0) {
          container.innerHTML = '<div class="empty">No links found.</div>';
          return;
        }

        const formatDate = (iso) => {
          const d = new Date(iso);
          const pad = n => String(n).padStart(2, '0');
          return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        };

        container.innerHTML = links.map(link => {
          const tags = parseTags(link.tags);
          let domain = link.url;
          try { domain = new URL(link.url).hostname.replace(/^www\./, ''); } catch {}
          return `
          <div class="link"
               data-url="${link.url}"
               data-added="${link.added || ''}"
               ${link.title ? `data-title="${link.title.replace(/"/g, '&quot;')}"` : ''}
               ${tags.length ? `data-tags="${tags.join(' ')}"` : ''}>
            <a href="${link.url}" target="_blank">
              <span class="title">${link.title || link.url}</span>
            </a>
            <span class="url">${domain}</span>
            ${link.added ? `<span class="added">${formatDate(link.added)}</span>` : ''}
            ${tags.length ? `<span class="tags">${tags.map(t => `<span class="tag">#${t}</span>`).join(' ')}</span>` : ''}
          </div>`;
        }).join('');
      } catch (err) {
        container.innerHTML = '<div class="empty">Failed to load links.</div>';
        console.error(err);
      }
    }

    loadLinks();
  </script>

  <!-- config for local dev; empty file in production -->
  <script src="/config.js" onerror=""></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    let accessToken = null;
    let tokenClient = null;

    function initGoogleAuth() {
      const clientId = window.GOOGLE_CLIENT_ID || '';
      if (!clientId) {
        document.getElementById('auth-btn').textContent = 'No OAuth configured';
        document.getElementById('auth-btn').disabled = true;
        return;
      }
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: clientId,
        scope: 'email',
        callback: (response) => {
          if (response.access_token) {
            accessToken = response.access_token;
            document.getElementById('auth-btn').textContent = 'Signed in';
            document.getElementById('auth-btn').disabled = true;
          }
        },
      });
    }

    function handleAuth() {
      if (tokenClient) {
        tokenClient.requestAccessToken();
      }
    }

    async function submitLink() {
      const urlInput = document.getElementById('link-url');
      const notesInput = document.getElementById('link-notes');
      const status = document.getElementById('submit-status');
      const url = urlInput.value.trim();
      const notes = notesInput.value.trim();

      if (!url) {
        status.textContent = 'Enter a URL';
        status.className = 'status-error';
        return;
      }

      if (!accessToken) {
        status.textContent = 'Sign in first';
        status.className = 'status-error';
        return;
      }

      const tagFilters = getTagFilters();
      const tags = tagFilters.filter(t => !t.startsWith('-')).join(' ');

      status.textContent = 'Submitting...';
      status.className = '';

      try {
        const response = await fetch('/.netlify/functions/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, tags, notes, googleToken: accessToken }),
        });

        const result = await response.json();

        if (response.ok) {
          status.textContent = 'Submitted!';
          status.className = 'status-success';
          urlInput.value = '';
          notesInput.value = '';
        } else {
          status.textContent = result.error || 'Failed';
          status.className = 'status-error';
        }
      } catch (e) {
        status.textContent = 'Network error';
        status.className = 'status-error';
      }
    }

    // Initialize auth when Google library loads
    window.addEventListener('load', () => {
      if (typeof google !== 'undefined') {
        initGoogleAuth();
      } else {
        // Library not loaded yet, wait for it
        const checkGoogle = setInterval(() => {
          if (typeof google !== 'undefined') {
            clearInterval(checkGoogle);
            initGoogleAuth();
          }
        }, 100);
      }
    });
  </script>
</body>
</html>
